---
import fs from 'node:fs';
import path from 'node:path';
import Layout from '../../layouts/Layout.astro';
import {
	SquirrelsongSpecPage,
	type ColorRow,
	type Palette,
	type CombinedPalette,
	type PaletteItem,
	getHexFromPaletteItem,
} from '../../templates/SquirrelsongSpecPage';
import { getContrastingTextColor } from '../../util/getContrastingTextColor';
import { hexToRgb } from '../../util/hexToRgb';

// Either take Squirrelsong repository path from the environment, or default to
// the local folder, created by sync-squirrelsong.ts script
const PALETTE_DIR = import.meta.env.SQRLSNG_DIR ?? 'squirrelsong-master';

function readPalette(filename: string): Palette {
	return JSON.parse(
		removeJsonComments(
			fs.readFileSync(path.join(PALETTE_DIR, filename)).toString()
		)
	);
}

/**
 * Remove comments from JSON.
 */
function removeJsonComments(json: string): string {
	return (
		json
			// Remove /* */ comments
			.replaceAll(/\/\*[\s\S]*?\*\//g, '')
			// Remove // comments
			.replaceAll(/\/\/.*/g, '')
	);
}

function hexToRgbString(hex: string) {
	return `RGB(${hexToRgb(hex).join(', ')})`;
}

function getDarkName(lightName: string) {
	return lightName;
}

function getDarkPurpleName(darkName: string) {
	return darkName
		.replace('gray', 'purple')
		.replace(/^brightYellowDimer$/, 'brightYellowDimerPurple')
		.replace(/^brightYellowDim$/, 'brightYellowDimPurple')
		.replace(/^brightYellow$/, 'brightYellowPurple');
}

function preparePalette(light: Palette, dark: Palette): CombinedPalette {
	return {
		light: Object.fromEntries(
			Object.entries(light).map(([key, item]) => [
				key,
				(Array.isArray(item)
					? [lightPalette[item[0]], item[1]]
					: lightPalette[item]) as PaletteItem,
			])
		),
		dark: Object.fromEntries(
			Object.entries(dark).map(([key, item]) => [
				key,
				(Array.isArray(item)
					? [darkPalette[item[0]], item[1]]
					: darkPalette[item]) as PaletteItem,
			])
		),
		darkPurple: Object.fromEntries(
			Object.entries(dark).map(([key, item]) => [
				key,
				(Array.isArray(item)
					? [darkPalette[getDarkPurpleName(item[0])], item[1]]
					: darkPalette[getDarkPurpleName(item)]) as PaletteItem,
			])
		),
	};
}

// --------------------- 8< -- 8< ---------------------

// Load palette files
const lightPalette = readPalette('light/palette.json');
const lightUiPalette = readPalette('light/ui.json');
const lightCodePalette = readPalette('light/code.json');
const lightAnsiPalette = readPalette('light/ansi.json');
const darkPalette = readPalette('dark/palette.json');
const darkUiPalette = readPalette('dark/ui.json');
const darkCodePalette = readPalette('dark/code.json');
const darkAnsiPalette = readPalette('dark/ansi.json');

const colorRows: ColorRow[] = Object.entries(lightPalette).map(
	([lightName, lightItem]) => {
		const lightHex = getHexFromPaletteItem(lightItem);
		const darkName = getDarkName(lightName);
		const darkItem = darkPalette[darkName];
		const darkHex = getHexFromPaletteItem(darkItem);
		const darkPurpleName = getDarkPurpleName(darkName);
		const darkPurpleItem = darkPalette[darkPurpleName];
		const darkPurpleHex = getHexFromPaletteItem(darkPurpleItem);

		return {
			light: {
				name: lightName,
				hex: lightHex,
				rgb: hexToRgbString(lightHex),
				textColor: getContrastingTextColor(lightHex),
			},
			dark: {
				name: darkName,
				hex: darkHex,
				rgb: hexToRgbString(darkHex),
				textColor: getContrastingTextColor(darkHex),
			},
			darkPurple: {
				name: darkPurpleName,
				hex: darkPurpleHex,
				rgb: hexToRgbString(darkPurpleHex),
				textColor: getContrastingTextColor(darkPurpleHex),
			},
		};
	}
);

const uiColors = preparePalette(lightUiPalette, darkUiPalette);
const codeColors = preparePalette(lightCodePalette, darkCodePalette);
const ansiColors = preparePalette(lightAnsiPalette, darkAnsiPalette);
---

<Layout
	url="/squirrelsong/spec/"
	title="Squirrelsong color theme specification"
	description="Complete color specification for Squirrelsong light and dark themes"
	component={SquirrelsongSpecPage}
	props={{ colorRows, uiColors, codeColors, ansiColors }}
/>
