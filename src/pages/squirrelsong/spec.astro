---
import fs from 'node:fs';
import path from 'node:path';
import Layout from '../../layouts/Layout.astro';
import {
	SquirrelsongSpecPage,
	type ColorRow,
} from '../../templates/SquirrelsongSpecPage';
import { getContrastingTextColor } from '../../util/getContrastingTextColor';
import { hexToRgb } from '../../util/hexToRgb';

const PALETTE_DIR = 'squirrelsong-master';

/**
 * Remove comments from JSON.
 */
function removeJsonComments(json: string): string {
	return (
		json
			// Remove /* */ comments
			.replaceAll(/\/\*[\s\S]*?\*\//g, '')
			// Remove // comments
			.replaceAll(/\/\/.*/g, '')
	);
}

// Load palette files
const lightPalette: Record<string, string> = JSON.parse(
	removeJsonComments(
		fs.readFileSync(path.join(PALETTE_DIR, 'light/palette.json')).toString()
	)
);
const darkPaletteRaw: Record<string, string> = JSON.parse(
	removeJsonComments(
		fs.readFileSync(path.join(PALETTE_DIR, 'dark/palette.json')).toString()
	)
);

const hexToRgbString = (hex: string) => `RGB(${hexToRgb(hex).join(', ')})`;

const getDarkName = (lightName: string) => {
	return lightName;
};
const getDarkPurpleName = (darkName: string) => {
	return darkName
		.replace('gray', 'purple')
		.replace(/^brightYellowDimer$/, 'brightYellowDimerPurple')
		.replace(/^brightYellowDim$/, 'brightYellowDimPurple')
		.replace(/^brightYellow$/, 'brightYellowPurple');
};

const colorRows: ColorRow[] = Object.entries(lightPalette).map(
	([lightName, lightHex]) => {
		const darkName = getDarkName(lightName);
		const darkHex = darkPaletteRaw[darkName];
		const darkPurpleName = getDarkPurpleName(darkName);
		const darkPurpleHex = darkPaletteRaw[darkPurpleName];

		return {
			light: {
				name: lightName,
				hex: lightHex,
				rgb: hexToRgbString(lightHex),
				textColor: getContrastingTextColor(lightHex),
			},
			dark: darkHex
				? {
						name: darkName,
						hex: darkHex,
						rgb: hexToRgbString(darkHex),
						textColor: getContrastingTextColor(darkHex),
					}
				: undefined,
			darkPurple: darkPurpleHex
				? {
						name: darkPurpleName,
						hex: darkPurpleHex,
						rgb: hexToRgbString(darkPurpleHex),
						textColor: getContrastingTextColor(darkPurpleHex),
					}
				: undefined,
		};
	}
);
---

<Layout
	url="/squirrelsong/spec/"
	title="Squirrelsong color theme specification"
	description="Complete color specification for Squirrelsong light and dark themes"
	component={SquirrelsongSpecPage}
	props={{ colorRows }}
/>
